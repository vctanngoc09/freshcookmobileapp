<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/freshcookapp/ui/screen/chat/ChatDetailScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/freshcookapp/ui/screen/chat/ChatDetailScreen.kt" />
              <option name="originalContent" value="package com.example.freshcookapp.ui.screen.chat&#10;&#10;import android.content.ClipData&#10;import android.content.ClipboardManager&#10;import android.content.Context&#10;import android.widget.Toast&#10;import android.util.Log&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.combinedClickable&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.foundation.lazy.rememberLazyListState&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.ArrowBack&#10;import androidx.compose.material.icons.filled.Send&#10;import androidx.compose.material.icons.filled.Image&#10;import androidx.compose.material.icons.filled.CameraAlt&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.layout.ContentScale&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.lifecycle.viewmodel.compose.viewModel&#10;import androidx.navigation.NavController&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import coil.compose.AsyncImage&#10;import com.example.freshcookapp.data.model.ChatMessage&#10;import com.google.firebase.auth.FirebaseAuth&#10;import com.google.firebase.firestore.FirebaseFirestore&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.tasks.await&#10;import java.text.SimpleDateFormat&#10;import java.util.Date&#10;import java.util.Locale&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun ChatDetailScreen(&#10;    chatId: String,&#10;    navController: NavController,&#10;    viewModel: ChatViewModel = viewModel()&#10;) {&#10;    val messages by viewModel.messages.collectAsState()&#10;    val currentChat by viewModel.currentChat.collectAsState()&#10;    val isLoading by viewModel.isLoading.collectAsState()&#10;    val error by viewModel.error.collectAsState()&#10;    val isOtherUserTyping by viewModel.isOtherUserTyping.collectAsState()&#10;    val canLoadMore by viewModel.canLoadMore.collectAsState()&#10;    val isLoadingMore by viewModel.isLoadingMore.collectAsState()&#10;    val isUploadingImage by viewModel.isUploadingImage.collectAsState()&#10;&#10;    var messageText by remember { mutableStateOf(&quot;&quot;) }&#10;    var showImageOptions by remember { mutableStateOf(false) }&#10;    val listState = rememberLazyListState()&#10;    val coroutineScope = rememberCoroutineScope()&#10;&#10;    //  SỬA: Load chat info trước rồi mới lấy thông tin user&#10;    LaunchedEffect(chatId) {&#10;        viewModel.loadChatMessages(chatId)&#10;    }&#10;&#10;    //  SỬA: Lấy thông tin user từ currentChat (được cập nhật bởi loadChatMessages)&#10;    val otherUser = currentChat?.let { viewModel.getOtherUser(it) }&#10;    val otherUserName = otherUser?.get(&quot;username&quot;) as? String&#10;        ?: otherUser?.get(&quot;name&quot;) as? String&#10;        ?: otherUser?.get(&quot;displayName&quot;) as? String&#10;        ?: &quot;Loading...&quot;&#10;    val otherUserPhoto = otherUser?.get(&quot;photoUrl&quot;) as? String&#10;        ?: otherUser?.get(&quot;profileImage&quot;) as? String&#10;        ?: otherUser?.get(&quot;avatar&quot;) as? String&#10;&#10;    //  THÊM: Fallback - Load thông tin chi tiết từ Firebase nếu cần&#10;    var firebaseUserName by remember { mutableStateOf&lt;String?&gt;(null) }&#10;    var firebaseUserPhoto by remember { mutableStateOf&lt;String?&gt;(null) }&#10;&#10;    LaunchedEffect(currentChat) {&#10;        currentChat?.let { chat -&gt;&#10;            val currentUserId = FirebaseAuth.getInstance().currentUser?.uid&#10;            val otherUserId = chat.participantIds.firstOrNull { it != currentUserId }&#10;&#10;            Log.d(&quot;ChatDetailScreen&quot;, &quot;Current user ID: $currentUserId&quot;)&#10;            Log.d(&quot;ChatDetailScreen&quot;, &quot;Participant IDs: ${chat.participantIds}&quot;)&#10;            Log.d(&quot;ChatDetailScreen&quot;, &quot;Other user ID: $otherUserId&quot;)&#10;            Log.d(&quot;ChatDetailScreen&quot;, &quot;Participants map: ${chat.participants}&quot;)&#10;&#10;            if (otherUserId != null) {&#10;                try {&#10;                    Log.d(&quot;ChatDetailScreen&quot;, &quot;Loading user info from Firestore for: $otherUserId&quot;)&#10;                    val userDoc = FirebaseFirestore.getInstance()&#10;                        .collection(&quot;users&quot;)&#10;                        .document(otherUserId)&#10;                        .get()&#10;                        .await()&#10;&#10;                    if (userDoc.exists()) {&#10;                        Log.d(&quot;ChatDetailScreen&quot;, &quot;User doc exists: ${userDoc.data}&quot;)&#10;&#10;                        // Thử nhiều key khác nhau cho tên&#10;                        val userName = userDoc.getString(&quot;username&quot;)&#10;                            ?: userDoc.getString(&quot;name&quot;)&#10;                            ?: userDoc.getString(&quot;displayName&quot;)&#10;                            ?: userDoc.getString(&quot;fullName&quot;)&#10;&#10;                        // Thử nhiều key khác nhau cho ảnh&#10;                        val userPhoto = userDoc.getString(&quot;profileImage&quot;)&#10;                            ?: userDoc.getString(&quot;photoUrl&quot;)&#10;                            ?: userDoc.getString(&quot;avatar&quot;)&#10;                            ?: userDoc.getString(&quot;profilePicture&quot;)&#10;&#10;                        // Cập nhật nếu tìm thấy giá trị hợp lệ&#10;                        if (!userName.isNullOrBlank()) {&#10;                            firebaseUserName = userName&#10;                            Log.d(&quot;ChatDetailScreen&quot;, &quot;✅ Updated name from Firestore: $userName&quot;)&#10;                        }&#10;&#10;                        if (!userPhoto.isNullOrBlank()) {&#10;                            firebaseUserPhoto = userPhoto&#10;                            Log.d(&quot;ChatDetailScreen&quot;, &quot;✅ Updated photo from Firestore: $userPhoto&quot;)&#10;                        }&#10;                    } else {&#10;                        Log.w(&quot;ChatDetailScreen&quot;, &quot;❌ User document does not exist for ID: $otherUserId&quot;)&#10;                    }&#10;                } catch (e: Exception) {&#10;                    Log.e(&quot;ChatDetailScreen&quot;, &quot;❌ Error loading user info: ${e.message}&quot;, e)&#10;                }&#10;            } else {&#10;                Log.w(&quot;ChatDetailScreen&quot;, &quot;❌ Could not find other user ID in participantIds: ${chat.participantIds}&quot;)&#10;            }&#10;        }&#10;    }&#10;&#10;    //  SỬA: Sử dụng giá trị từ Firebase nếu có, nếu không dùng từ Chat object&#10;    val displayName = firebaseUserName ?: otherUserName&#10;    val displayPhoto = firebaseUserPhoto ?: otherUserPhoto&#10;&#10;    //  THÊM: Image picker launcher&#10;    val galleryLauncher = rememberLauncherForActivityResult(&#10;        contract = ActivityResultContracts.GetContent()&#10;    ) { uri -&gt;&#10;        uri?.let { viewModel.uploadAndSendImage(chatId, it) }&#10;    }&#10;&#10;    // Load messages khi vào màn hình&#10;    LaunchedEffect(chatId) {&#10;        viewModel.loadChatMessages(chatId)&#10;    }&#10;&#10;    // Auto scroll xuống khi có tin nhắn mới&#10;    LaunchedEffect(messages.size) {&#10;        if (messages.isNotEmpty()) {&#10;            coroutineScope.launch {&#10;                listState.animateScrollToItem(messages.size - 1)&#10;            }&#10;        }&#10;    }&#10;&#10;    // Lắng nghe typing status&#10;    LaunchedEffect(messageText) {&#10;        viewModel.onTypingTextChanged(chatId, messageText)&#10;    }&#10;&#10;    //  THÊM: Detect khi scroll đến đầu list → load more&#10;    LaunchedEffect(listState) {&#10;        snapshotFlow { listState.firstVisibleItemIndex }&#10;            .collect { index -&gt;&#10;                if (index == 0 &amp;&amp; canLoadMore &amp;&amp; !isLoadingMore &amp;&amp; messages.isNotEmpty()) {&#10;                    viewModel.loadMoreMessages(chatId)&#10;                }&#10;            }&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            TopAppBar(&#10;                title = {&#10;                    Row(verticalAlignment = Alignment.CenterVertically) {&#10;                        AsyncImage(&#10;                            model = displayPhoto?.ifEmpty { null },&#10;                            contentDescription = &quot;Avatar&quot;,&#10;                            modifier = Modifier&#10;                                .size(36.dp)&#10;                                .clip(CircleShape)&#10;                                .background(Color.Gray),&#10;                            contentScale = ContentScale.Crop&#10;                        )&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;                        Column {&#10;                            Text(&#10;                                text = displayName ?: &quot;Unknown&quot;,&#10;                                style = MaterialTheme.typography.titleMedium,&#10;                                fontWeight = FontWeight.Bold&#10;                            )&#10;                            if (isOtherUserTyping) {&#10;                                Text(&#10;                                    text = &quot;đang nhập...&quot;,&#10;                                    style = MaterialTheme.typography.bodySmall,&#10;                                    color = Color.White.copy(alpha = 0.8f)&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;                },&#10;                navigationIcon = {&#10;                    IconButton(onClick = { navController.navigateUp() }) {&#10;                        Icon(Icons.Default.ArrowBack, &quot;Quay lại&quot;, tint = Color.White)&#10;                    }&#10;                },&#10;                colors = TopAppBarDefaults.topAppBarColors(&#10;                    containerColor = MaterialTheme.colorScheme.primary,&#10;                    titleContentColor = Color.White&#10;                )&#10;            )&#10;        },&#10;        bottomBar = {&#10;            Surface(&#10;                shadowElevation = 8.dp,&#10;                color = MaterialTheme.colorScheme.surface&#10;            ) {&#10;                Column {&#10;                    //  THÊM: Upload progress indicator&#10;                    if (isUploadingImage) {&#10;                        LinearProgressIndicator(&#10;                            modifier = Modifier.fillMaxWidth()&#10;                        )&#10;                    }&#10;&#10;                    Row(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(8.dp),&#10;                        verticalAlignment = Alignment.CenterVertically&#10;                    ) {&#10;                        //  THÊM: Image button&#10;                        IconButton(onClick = { showImageOptions = true }) {&#10;                            Icon(&#10;                                Icons.Default.Image,&#10;                                contentDescription = &quot;Chọn ảnh&quot;,&#10;                                tint = MaterialTheme.colorScheme.primary&#10;                            )&#10;                        }&#10;&#10;                        OutlinedTextField(&#10;                            value = messageText,&#10;                            onValueChange = { messageText = it },&#10;                            modifier = Modifier.weight(1f),&#10;                            placeholder = { Text(&quot;Nhập tin nhắn...&quot;) },&#10;                            shape = RoundedCornerShape(24.dp),&#10;                            maxLines = 3&#10;                        )&#10;&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        //  ICON GỬI - CẢI THIỆN&#10;                        IconButton(&#10;                            onClick = {&#10;                                if (messageText.isNotBlank()) {&#10;                                    viewModel.sendMessage(chatId, messageText.trim())&#10;                                    messageText = &quot;&quot;&#10;                                }&#10;                            },&#10;                            enabled = messageText.isNotBlank() &amp;&amp; !isUploadingImage,&#10;                            modifier = Modifier&#10;                                .size(48.dp)&#10;                                .background(&#10;                                    color = if (messageText.isNotBlank() &amp;&amp; !isUploadingImage)&#10;                                        MaterialTheme.colorScheme.primary&#10;                                    else Color.LightGray,&#10;                                    shape = CircleShape&#10;                                )&#10;                        ) {&#10;                            Icon(&#10;                                Icons.Default.Send,&#10;                                contentDescription = &quot;Gửi&quot;,&#10;                                tint = Color.White,&#10;                                modifier = Modifier.size(24.dp)&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    ) { paddingValues -&gt;&#10;        Box(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(paddingValues)&#10;        ) {&#10;            when {&#10;                isLoading &amp;&amp; messages.isEmpty() -&gt; {&#10;                    CircularProgressIndicator(&#10;                        modifier = Modifier.align(Alignment.Center)&#10;                    )&#10;                }&#10;                error != null -&gt; {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxSize()&#10;                            .padding(16.dp),&#10;                        horizontalAlignment = Alignment.CenterHorizontally,&#10;                        verticalArrangement = Arrangement.Center&#10;                    ) {&#10;                        Text(&#10;                            text = error ?: &quot;Có lỗi xảy ra&quot;,&#10;                            color = MaterialTheme.colorScheme.error&#10;                        )&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;                        Button(onClick = { viewModel.clearError() }) {&#10;                            Text(&quot;Đóng&quot;)&#10;                        }&#10;                    }&#10;                }&#10;                messages.isEmpty() -&gt; {&#10;                    Text(&#10;                        text = &quot;Chưa có tin nhắn nào\nHãy gửi tin nhắn đầu tiên!&quot;,&#10;                        modifier = Modifier.align(Alignment.Center),&#10;                        style = MaterialTheme.typography.bodyLarge,&#10;                        color = Color.Gray&#10;                    )&#10;                }&#10;                else -&gt; {&#10;                    LazyColumn(&#10;                        state = listState,&#10;                        modifier = Modifier.fillMaxSize(),&#10;                        contentPadding = PaddingValues(16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        //  THÊM: Loading indicator khi load more&#10;                        if (isLoadingMore) {&#10;                            item {&#10;                                Box(&#10;                                    modifier = Modifier&#10;                                        .fillMaxWidth()&#10;                                        .padding(8.dp),&#10;                                    contentAlignment = Alignment.Center&#10;                                ) {&#10;                                    CircularProgressIndicator(modifier = Modifier.size(24.dp))&#10;                                }&#10;                            }&#10;                        }&#10;&#10;                        items(messages) { message -&gt;&#10;                            MessageBubble(&#10;                                message = message,&#10;                                isCurrentUser = message.senderId == viewModel.getCurrentUserId(),&#10;                                onDelete = {&#10;                                    viewModel.deleteMessage(chatId, message.id)&#10;                                }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    //  THÊM: Bottom sheet cho chọn ảnh từ gallery hoặc camera&#10;    if (showImageOptions) {&#10;        AlertDialog(&#10;            onDismissRequest = { showImageOptions = false },&#10;            title = { Text(&quot;Chọn ảnh&quot;) },&#10;            text = {&#10;                Column {&#10;                    TextButton(&#10;                        onClick = {&#10;                            showImageOptions = false&#10;                            galleryLauncher.launch(&quot;image/*&quot;)&#10;                        },&#10;                        modifier = Modifier.fillMaxWidth()&#10;                    ) {&#10;                        Icon(Icons.Default.Image, null)&#10;                        Spacer(Modifier.width(8.dp))&#10;                        Text(&quot;Từ thư viện&quot;)&#10;                    }&#10;&#10;                    TextButton(&#10;                        onClick = {&#10;                            showImageOptions = false&#10;                            // Note: Camera requires more setup (file provider, permissions)&#10;                            // For now, just use gallery&#10;                            galleryLauncher.launch(&quot;image/*&quot;)&#10;                        },&#10;                        modifier = Modifier.fillMaxWidth()&#10;                    ) {&#10;                        Icon(Icons.Default.CameraAlt, null)&#10;                        Spacer(Modifier.width(8.dp))&#10;                        Text(&quot;Chụp ảnh&quot;)&#10;                    }&#10;                }&#10;            },&#10;            confirmButton = {&#10;                TextButton(onClick = { showImageOptions = false }) {&#10;                    Text(&quot;Hủy&quot;)&#10;                }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;fun MessageBubble(&#10;    message: ChatMessage,&#10;    isCurrentUser: Boolean,&#10;    onDelete: () -&gt; Unit = {}&#10;) {&#10;    var showDeleteDialog by remember { mutableStateOf(false) }&#10;    var showOptionsDialog by remember { mutableStateOf(false) }  //  THÊM&#10;    val context = LocalContext.current  //  THÊM&#10;&#10;    Row(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .combinedClickable(&#10;                onClick = {},&#10;                onLongClick = {&#10;                    showOptionsDialog = true  //  THAY ĐỔI&#10;                }&#10;            ),&#10;        horizontalArrangement = if (isCurrentUser) Arrangement.End else Arrangement.Start&#10;    ) {&#10;        Surface(&#10;            shape = RoundedCornerShape(&#10;                topStart = 16.dp,&#10;                topEnd = 16.dp,&#10;                bottomStart = if (isCurrentUser) 16.dp else 4.dp,&#10;                bottomEnd = if (isCurrentUser) 4.dp else 16.dp&#10;            ),&#10;            color = if (isCurrentUser)&#10;                MaterialTheme.colorScheme.primary&#10;            else&#10;                MaterialTheme.colorScheme.surfaceVariant,&#10;            modifier = Modifier.widthIn(max = 280.dp)&#10;        ) {&#10;            Column(&#10;                modifier = Modifier.padding(12.dp)&#10;            ) {&#10;                // Hiển thị ảnh nếu có&#10;                message.imageUrl?.let { url -&gt;&#10;                    AsyncImage(&#10;                        model = url,&#10;                        contentDescription = &quot;Ảnh&quot;,&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .heightIn(max = 200.dp)&#10;                            .clip(RoundedCornerShape(8.dp)),&#10;                        contentScale = ContentScale.Crop&#10;                    )&#10;                    if (message.text.isNotBlank()) {&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;                    }&#10;                }&#10;&#10;                // Hiển thị text&#10;                if (message.text.isNotBlank()) {&#10;                    Text(&#10;                        text = message.text,&#10;                        color = if (isCurrentUser) Color.White else Color.Black,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(4.dp))&#10;&#10;                // Timestamp&#10;                Text(&#10;                    text = formatFullTimestamp(message.timestamp),&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = if (isCurrentUser)&#10;                        Color.White.copy(alpha = 0.7f)&#10;                    else&#10;                        Color.Gray,&#10;                    modifier = Modifier.align(Alignment.End)&#10;                )&#10;            }&#10;        }&#10;    }&#10;&#10;    //  THÊM: Dialog với nhiều options&#10;    if (showOptionsDialog) {&#10;        AlertDialog(&#10;            onDismissRequest = { showOptionsDialog = false },&#10;            title = { Text(&quot;Tùy chọn&quot;) },&#10;            text = {&#10;                Column {&#10;                    // Copy text&#10;                    if (message.text.isNotBlank()) {&#10;                        TextButton(&#10;                            onClick = {&#10;                                val clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager&#10;                                val clip = ClipData.newPlainText(&quot;message&quot;, message.text)&#10;                                clipboard.setPrimaryClip(clip)&#10;                                Toast.makeText(context, &quot;Đã copy tin nhắn&quot;, Toast.LENGTH_SHORT).show()&#10;                                showOptionsDialog = false&#10;                            },&#10;                            modifier = Modifier.fillMaxWidth()&#10;                        ) {&#10;                            Text(&quot; Copy text&quot;)&#10;                        }&#10;                    }&#10;&#10;                    // Delete (chỉ với tin nhắn của mình)&#10;                    if (isCurrentUser) {&#10;                        TextButton(&#10;                            onClick = {&#10;                                showOptionsDialog = false&#10;                                showDeleteDialog = true&#10;                            },&#10;                            modifier = Modifier.fillMaxWidth()&#10;                        ) {&#10;                            Text(&quot;️ Xóa tin nhắn&quot;, color = MaterialTheme.colorScheme.error)&#10;                        }&#10;                    }&#10;                }&#10;            },&#10;            confirmButton = {&#10;                TextButton(onClick = { showOptionsDialog = false }) {&#10;                    Text(&quot;Đóng&quot;)&#10;                }&#10;            }&#10;        )&#10;    }&#10;&#10;    //  Dialog xác nhận xóa&#10;    if (showDeleteDialog) {&#10;        AlertDialog(&#10;            onDismissRequest = { showDeleteDialog = false },&#10;            title = { Text(&quot;Xóa tin nhắn&quot;) },&#10;            text = { Text(&quot;Bạn có chắc muốn xóa tin nhắn này?&quot;) },&#10;            confirmButton = {&#10;                TextButton(&#10;                    onClick = {&#10;                        onDelete()&#10;                        showDeleteDialog = false&#10;                    }&#10;                ) {&#10;                    Text(&quot;Xóa&quot;, color = MaterialTheme.colorScheme.error)&#10;                }&#10;            },&#10;            dismissButton = {&#10;                TextButton(onClick = { showDeleteDialog = false }) {&#10;                    Text(&quot;Hủy&quot;)&#10;                }&#10;            }&#10;        )&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.freshcookapp.ui.screen.chat&#10;&#10;import android.content.ClipData&#10;import android.content.ClipboardManager&#10;import android.content.Context&#10;import android.widget.Toast&#10;import android.util.Log&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.combinedClickable&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.foundation.lazy.rememberLazyListState&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.ArrowBack&#10;import androidx.compose.material.icons.filled.Send&#10;import androidx.compose.material.icons.filled.Image&#10;import androidx.compose.material.icons.filled.CameraAlt&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.layout.ContentScale&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.lifecycle.viewmodel.compose.viewModel&#10;import androidx.navigation.NavController&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import coil.compose.AsyncImage&#10;import com.example.freshcookapp.data.model.ChatMessage&#10;import com.google.firebase.auth.FirebaseAuth&#10;import com.google.firebase.firestore.FirebaseFirestore&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.tasks.await&#10;import java.text.SimpleDateFormat&#10;import java.util.Date&#10;import java.util.Locale&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun ChatDetailScreen(&#10;    chatId: String,&#10;    navController: NavController,&#10;    viewModel: ChatViewModel = viewModel()&#10;) {&#10;    val messages by viewModel.messages.collectAsState()&#10;    val currentChat by viewModel.currentChat.collectAsState()&#10;    val isLoading by viewModel.isLoading.collectAsState()&#10;    val error by viewModel.error.collectAsState()&#10;    val isOtherUserTyping by viewModel.isOtherUserTyping.collectAsState()&#10;    val canLoadMore by viewModel.canLoadMore.collectAsState()&#10;    val isLoadingMore by viewModel.isLoadingMore.collectAsState()&#10;    val isUploadingImage by viewModel.isUploadingImage.collectAsState()&#10;&#10;    var messageText by remember { mutableStateOf(&quot;&quot;) }&#10;    var showImageOptions by remember { mutableStateOf(false) }&#10;    val listState = rememberLazyListState()&#10;    val coroutineScope = rememberCoroutineScope()&#10;&#10;    //  SỬA: Load chat info trước rồi mới lấy thông tin user&#10;    LaunchedEffect(chatId) {&#10;        viewModel.loadChatMessages(chatId)&#10;    }&#10;&#10;    //  SỬA: Lấy thông tin user từ currentChat (được cập nhật bởi loadChatMessages)&#10;    val otherUser = currentChat?.let { viewModel.getOtherUser(it) }&#10;    val otherUserName = otherUser?.get(&quot;username&quot;) as? String&#10;        ?: otherUser?.get(&quot;name&quot;) as? String&#10;        ?: otherUser?.get(&quot;displayName&quot;) as? String&#10;        ?: &quot;Loading...&quot;&#10;    val otherUserPhoto = otherUser?.get(&quot;photoUrl&quot;) as? String&#10;        ?: otherUser?.get(&quot;profileImage&quot;) as? String&#10;        ?: otherUser?.get(&quot;avatar&quot;) as? String&#10;&#10;    //  THÊM: Fallback - Load thông tin chi tiết từ Firebase nếu cần&#10;    var firebaseUserName by remember { mutableStateOf&lt;String?&gt;(null) }&#10;    var firebaseUserPhoto by remember { mutableStateOf&lt;String?&gt;(null) }&#10;&#10;    LaunchedEffect(currentChat) {&#10;        currentChat?.let { chat -&gt;&#10;            val currentUserId = FirebaseAuth.getInstance().currentUser?.uid&#10;            val otherUserId = chat.participantIds.firstOrNull { it != currentUserId }&#10;&#10;            Log.d(&quot;ChatDetailScreen&quot;, &quot;Current user ID: $currentUserId&quot;)&#10;            Log.d(&quot;ChatDetailScreen&quot;, &quot;Participant IDs: ${chat.participantIds}&quot;)&#10;            Log.d(&quot;ChatDetailScreen&quot;, &quot;Other user ID: $otherUserId&quot;)&#10;            Log.d(&quot;ChatDetailScreen&quot;, &quot;Participants map: ${chat.participants}&quot;)&#10;&#10;            if (otherUserId != null) {&#10;                try {&#10;                    Log.d(&quot;ChatDetailScreen&quot;, &quot;Loading user info from Firestore for: $otherUserId&quot;)&#10;                    val userDoc = FirebaseFirestore.getInstance()&#10;                        .collection(&quot;users&quot;)&#10;                        .document(otherUserId)&#10;                        .get()&#10;                        .await()&#10;&#10;                    if (userDoc.exists()) {&#10;                        Log.d(&quot;ChatDetailScreen&quot;, &quot;User doc exists: ${userDoc.data}&quot;)&#10;&#10;                        // Thử nhiều key khác nhau cho tên&#10;                        val userName = userDoc.getString(&quot;username&quot;)&#10;                            ?: userDoc.getString(&quot;name&quot;)&#10;                            ?: userDoc.getString(&quot;displayName&quot;)&#10;                            ?: userDoc.getString(&quot;fullName&quot;)&#10;&#10;                        // Thử nhiều key khác nhau cho ảnh&#10;                        val userPhoto = userDoc.getString(&quot;profileImage&quot;)&#10;                            ?: userDoc.getString(&quot;photoUrl&quot;)&#10;                            ?: userDoc.getString(&quot;avatar&quot;)&#10;                            ?: userDoc.getString(&quot;profilePicture&quot;)&#10;&#10;                        // Cập nhật nếu tìm thấy giá trị hợp lệ&#10;                        if (!userName.isNullOrBlank()) {&#10;                            firebaseUserName = userName&#10;                            Log.d(&quot;ChatDetailScreen&quot;, &quot;✅ Updated name from Firestore: $userName&quot;)&#10;                        }&#10;&#10;                        if (!userPhoto.isNullOrBlank()) {&#10;                            firebaseUserPhoto = userPhoto&#10;                            Log.d(&quot;ChatDetailScreen&quot;, &quot;✅ Updated photo from Firestore: $userPhoto&quot;)&#10;                        }&#10;                    } else {&#10;                        Log.w(&quot;ChatDetailScreen&quot;, &quot;❌ User document does not exist for ID: $otherUserId&quot;)&#10;                    }&#10;                } catch (e: Exception) {&#10;                    Log.e(&quot;ChatDetailScreen&quot;, &quot;❌ Error loading user info: ${e.message}&quot;, e)&#10;                }&#10;            } else {&#10;                Log.w(&quot;ChatDetailScreen&quot;, &quot;❌ Could not find other user ID in participantIds: ${chat.participantIds}&quot;)&#10;            }&#10;        }&#10;    }&#10;&#10;    //  SỬA: Sử dụng giá trị từ Firebase nếu có, nếu không dùng từ Chat object&#10;    val displayName = firebaseUserName ?: otherUserName&#10;    val displayPhoto = firebaseUserPhoto ?: otherUserPhoto&#10;&#10;    //  THÊM: Image picker launcher&#10;    val galleryLauncher = rememberLauncherForActivityResult(&#10;        contract = ActivityResultContracts.GetContent()&#10;    ) { uri -&gt;&#10;        uri?.let { viewModel.uploadAndSendImage(chatId, it) }&#10;    }&#10;&#10;    // Auto scroll xuống khi có tin nhắn mới&#10;    LaunchedEffect(messages.size) {&#10;        if (messages.isNotEmpty()) {&#10;            coroutineScope.launch {&#10;                listState.animateScrollToItem(messages.size - 1)&#10;            }&#10;        }&#10;    }&#10;&#10;    // Lắng nghe typing status&#10;    LaunchedEffect(messageText) {&#10;        viewModel.onTypingTextChanged(chatId, messageText)&#10;    }&#10;&#10;    //  THÊM: Detect khi scroll đến đầu list → load more&#10;    LaunchedEffect(listState) {&#10;        snapshotFlow { listState.firstVisibleItemIndex }&#10;            .collect { index -&gt;&#10;                if (index == 0 &amp;&amp; canLoadMore &amp;&amp; !isLoadingMore &amp;&amp; messages.isNotEmpty()) {&#10;                    viewModel.loadMoreMessages(chatId)&#10;                }&#10;            }&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            TopAppBar(&#10;                title = {&#10;                    Row(verticalAlignment = Alignment.CenterVertically) {&#10;                        AsyncImage(&#10;                            model = displayPhoto?.ifEmpty { null },&#10;                            contentDescription = &quot;Avatar&quot;,&#10;                            modifier = Modifier&#10;                                .size(36.dp)&#10;                                .clip(CircleShape)&#10;                                .background(Color.Gray),&#10;                            contentScale = ContentScale.Crop&#10;                        )&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;                        Column {&#10;                            Text(&#10;                                text = displayName ?: &quot;Unknown&quot;,&#10;                                style = MaterialTheme.typography.titleMedium,&#10;                                fontWeight = FontWeight.Bold&#10;                            )&#10;                            if (isOtherUserTyping) {&#10;                                Text(&#10;                                    text = &quot;đang nhập...&quot;,&#10;                                    style = MaterialTheme.typography.bodySmall,&#10;                                    color = Color.White.copy(alpha = 0.8f)&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;                },&#10;                navigationIcon = {&#10;                    IconButton(onClick = { navController.navigateUp() }) {&#10;                        Icon(Icons.Default.ArrowBack, &quot;Quay lại&quot;, tint = Color.White)&#10;                    }&#10;                },&#10;                colors = TopAppBarDefaults.topAppBarColors(&#10;                    containerColor = MaterialTheme.colorScheme.primary,&#10;                    titleContentColor = Color.White&#10;                )&#10;            )&#10;        },&#10;        bottomBar = {&#10;            Surface(&#10;                shadowElevation = 8.dp,&#10;                color = MaterialTheme.colorScheme.surface&#10;            ) {&#10;                Column {&#10;                    //  THÊM: Upload progress indicator&#10;                    if (isUploadingImage) {&#10;                        LinearProgressIndicator(&#10;                            modifier = Modifier.fillMaxWidth()&#10;                        )&#10;                    }&#10;&#10;                    Row(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(8.dp),&#10;                        verticalAlignment = Alignment.CenterVertically&#10;                    ) {&#10;                        //  THÊM: Image button&#10;                        IconButton(onClick = { showImageOptions = true }) {&#10;                            Icon(&#10;                                Icons.Default.Image,&#10;                                contentDescription = &quot;Chọn ảnh&quot;,&#10;                                tint = MaterialTheme.colorScheme.primary&#10;                            )&#10;                        }&#10;&#10;                        OutlinedTextField(&#10;                            value = messageText,&#10;                            onValueChange = { messageText = it },&#10;                            modifier = Modifier.weight(1f),&#10;                            placeholder = { Text(&quot;Nhập tin nhắn...&quot;) },&#10;                            shape = RoundedCornerShape(24.dp),&#10;                            maxLines = 3&#10;                        )&#10;&#10;                        Spacer(modifier = Modifier.width(8.dp))&#10;&#10;                        //  ICON GỬI - CẢI THIỆN&#10;                        IconButton(&#10;                            onClick = {&#10;                                if (messageText.isNotBlank()) {&#10;                                    viewModel.sendMessage(chatId, messageText.trim())&#10;                                    messageText = &quot;&quot;&#10;                                }&#10;                            },&#10;                            enabled = messageText.isNotBlank() &amp;&amp; !isUploadingImage,&#10;                            modifier = Modifier&#10;                                .size(48.dp)&#10;                                .background(&#10;                                    color = if (messageText.isNotBlank() &amp;&amp; !isUploadingImage)&#10;                                        MaterialTheme.colorScheme.primary&#10;                                    else Color.LightGray,&#10;                                    shape = CircleShape&#10;                                )&#10;                        ) {&#10;                            Icon(&#10;                                Icons.Default.Send,&#10;                                contentDescription = &quot;Gửi&quot;,&#10;                                tint = Color.White,&#10;                                modifier = Modifier.size(24.dp)&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    ) { paddingValues -&gt;&#10;        Box(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(paddingValues)&#10;        ) {&#10;            when {&#10;                isLoading &amp;&amp; messages.isEmpty() -&gt; {&#10;                    CircularProgressIndicator(&#10;                        modifier = Modifier.align(Alignment.Center)&#10;                    )&#10;                }&#10;                error != null -&gt; {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxSize()&#10;                            .padding(16.dp),&#10;                        horizontalAlignment = Alignment.CenterHorizontally,&#10;                        verticalArrangement = Arrangement.Center&#10;                    ) {&#10;                        Text(&#10;                            text = error ?: &quot;Có lỗi xảy ra&quot;,&#10;                            color = MaterialTheme.colorScheme.error&#10;                        )&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;                        Button(onClick = { viewModel.clearError() }) {&#10;                            Text(&quot;Đóng&quot;)&#10;                        }&#10;                    }&#10;                }&#10;                messages.isEmpty() -&gt; {&#10;                    Text(&#10;                        text = &quot;Chưa có tin nhắn nào\nHãy gửi tin nhắn đầu tiên!&quot;,&#10;                        modifier = Modifier.align(Alignment.Center),&#10;                        style = MaterialTheme.typography.bodyLarge,&#10;                        color = Color.Gray&#10;                    )&#10;                }&#10;                else -&gt; {&#10;                    LazyColumn(&#10;                        state = listState,&#10;                        modifier = Modifier.fillMaxSize(),&#10;                        contentPadding = PaddingValues(16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        //  THÊM: Loading indicator khi load more&#10;                        if (isLoadingMore) {&#10;                            item {&#10;                                Box(&#10;                                    modifier = Modifier&#10;                                        .fillMaxWidth()&#10;                                        .padding(8.dp),&#10;                                    contentAlignment = Alignment.Center&#10;                                ) {&#10;                                    CircularProgressIndicator(modifier = Modifier.size(24.dp))&#10;                                }&#10;                            }&#10;                        }&#10;&#10;                        items(messages) { message -&gt;&#10;                            MessageBubble(&#10;                                message = message,&#10;                                isCurrentUser = message.senderId == viewModel.getCurrentUserId(),&#10;                                onDelete = {&#10;                                    viewModel.deleteMessage(chatId, message.id)&#10;                                }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    //  THÊM: Bottom sheet cho chọn ảnh từ gallery hoặc camera&#10;    if (showImageOptions) {&#10;        AlertDialog(&#10;            onDismissRequest = { showImageOptions = false },&#10;            title = { Text(&quot;Chọn ảnh&quot;) },&#10;            text = {&#10;                Column {&#10;                    TextButton(&#10;                        onClick = {&#10;                            showImageOptions = false&#10;                            galleryLauncher.launch(&quot;image/*&quot;)&#10;                        },&#10;                        modifier = Modifier.fillMaxWidth()&#10;                    ) {&#10;                        Icon(Icons.Default.Image, null)&#10;                        Spacer(Modifier.width(8.dp))&#10;                        Text(&quot;Từ thư viện&quot;)&#10;                    }&#10;&#10;                    TextButton(&#10;                        onClick = {&#10;                            showImageOptions = false&#10;                            // Note: Camera requires more setup (file provider, permissions)&#10;                            // For now, just use gallery&#10;                            galleryLauncher.launch(&quot;image/*&quot;)&#10;                        },&#10;                        modifier = Modifier.fillMaxWidth()&#10;                    ) {&#10;                        Icon(Icons.Default.CameraAlt, null)&#10;                        Spacer(Modifier.width(8.dp))&#10;                        Text(&quot;Chụp ảnh&quot;)&#10;                    }&#10;                }&#10;            },&#10;            confirmButton = {&#10;                TextButton(onClick = { showImageOptions = false }) {&#10;                    Text(&quot;Hủy&quot;)&#10;                }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;fun MessageBubble(&#10;    message: ChatMessage,&#10;    isCurrentUser: Boolean,&#10;    onDelete: () -&gt; Unit = {}&#10;) {&#10;    var showDeleteDialog by remember { mutableStateOf(false) }&#10;    var showOptionsDialog by remember { mutableStateOf(false) }  //  THÊM&#10;    val context = LocalContext.current  //  THÊM&#10;&#10;    Row(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .combinedClickable(&#10;                onClick = {},&#10;                onLongClick = {&#10;                    showOptionsDialog = true  //  THAY ĐỔI&#10;                }&#10;            ),&#10;        horizontalArrangement = if (isCurrentUser) Arrangement.End else Arrangement.Start&#10;    ) {&#10;        Surface(&#10;            shape = RoundedCornerShape(&#10;                topStart = 16.dp,&#10;                topEnd = 16.dp,&#10;                bottomStart = if (isCurrentUser) 16.dp else 4.dp,&#10;                bottomEnd = if (isCurrentUser) 4.dp else 16.dp&#10;            ),&#10;            color = if (isCurrentUser)&#10;                MaterialTheme.colorScheme.primary&#10;            else&#10;                MaterialTheme.colorScheme.surfaceVariant,&#10;            modifier = Modifier.widthIn(max = 280.dp)&#10;        ) {&#10;            Column(&#10;                modifier = Modifier.padding(12.dp)&#10;            ) {&#10;                // Hiển thị ảnh nếu có&#10;                message.imageUrl?.let { url -&gt;&#10;                    AsyncImage(&#10;                        model = url,&#10;                        contentDescription = &quot;Ảnh&quot;,&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .heightIn(max = 200.dp)&#10;                            .clip(RoundedCornerShape(8.dp)),&#10;                        contentScale = ContentScale.Crop&#10;                    )&#10;                    if (message.text.isNotBlank()) {&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;                    }&#10;                }&#10;&#10;                // Hiển thị text&#10;                if (message.text.isNotBlank()) {&#10;                    Text(&#10;                        text = message.text,&#10;                        color = if (isCurrentUser) Color.White else Color.Black,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(4.dp))&#10;&#10;                // Timestamp&#10;                Text(&#10;                    text = formatFullTimestamp(message.timestamp),&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = if (isCurrentUser)&#10;                        Color.White.copy(alpha = 0.7f)&#10;                    else&#10;                        Color.Gray,&#10;                    modifier = Modifier.align(Alignment.End)&#10;                )&#10;            }&#10;        }&#10;    }&#10;&#10;    //  THÊM: Dialog với nhiều options&#10;    if (showOptionsDialog) {&#10;        AlertDialog(&#10;            onDismissRequest = { showOptionsDialog = false },&#10;            title = { Text(&quot;Tùy chọn&quot;) },&#10;            text = {&#10;                Column {&#10;                    // Copy text&#10;                    if (message.text.isNotBlank()) {&#10;                        TextButton(&#10;                            onClick = {&#10;                                val clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager&#10;                                val clip = ClipData.newPlainText(&quot;message&quot;, message.text)&#10;                                clipboard.setPrimaryClip(clip)&#10;                                Toast.makeText(context, &quot;Đã copy tin nhắn&quot;, Toast.LENGTH_SHORT).show()&#10;                                showOptionsDialog = false&#10;                            },&#10;                            modifier = Modifier.fillMaxWidth()&#10;                        ) {&#10;                            Text(&quot; Copy text&quot;)&#10;                        }&#10;                    }&#10;&#10;                    // Delete (chỉ với tin nhắn của mình)&#10;                    if (isCurrentUser) {&#10;                        TextButton(&#10;                            onClick = {&#10;                                showOptionsDialog = false&#10;                                showDeleteDialog = true&#10;                            },&#10;                            modifier = Modifier.fillMaxWidth()&#10;                        ) {&#10;                            Text(&quot;️ Xóa tin nhắn&quot;, color = MaterialTheme.colorScheme.error)&#10;                        }&#10;                    }&#10;                }&#10;            },&#10;            confirmButton = {&#10;                TextButton(onClick = { showOptionsDialog = false }) {&#10;                    Text(&quot;Đóng&quot;)&#10;                }&#10;            }&#10;        )&#10;    }&#10;&#10;    //  Dialog xác nhận xóa&#10;    if (showDeleteDialog) {&#10;        AlertDialog(&#10;            onDismissRequest = { showDeleteDialog = false },&#10;            title = { Text(&quot;Xóa tin nhắn&quot;) },&#10;            text = { Text(&quot;Bạn có chắc muốn xóa tin nhắn này?&quot;) },&#10;            confirmButton = {&#10;                TextButton(&#10;                    onClick = {&#10;                        onDelete()&#10;                        showDeleteDialog = false&#10;                    }&#10;                ) {&#10;                    Text(&quot;Xóa&quot;, color = MaterialTheme.colorScheme.error)&#10;                }&#10;            },&#10;            dismissButton = {&#10;                TextButton(onClick = { showDeleteDialog = false }) {&#10;                    Text(&quot;Hủy&quot;)&#10;                }&#10;            }&#10;        )&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>