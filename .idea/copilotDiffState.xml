<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/freshcookapp/ui/screen/auth/FirebaseAuthHelper.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/freshcookapp/ui/screen/auth/FirebaseAuthHelper.kt" />
              <option name="originalContent" value="package com.example.freshcookapp.ui.screen.auth&#10;&#10;import android.app.Activity&#10;import android.net.Uri&#10;import com.facebook.AccessToken&#10;import com.google.firebase.auth.FacebookAuthProvider&#10;import com.google.firebase.auth.FirebaseAuth&#10;import com.google.firebase.auth.FirebaseUser&#10;import com.google.firebase.auth.GoogleAuthProvider&#10;import com.google.firebase.auth.OAuthProvider&#10;import com.google.firebase.auth.UserProfileChangeRequest&#10;import com.google.firebase.firestore.FirebaseFirestore&#10;import com.google.firebase.firestore.SetOptions&#10;&#10;// --- GOOGLE AUTH ---&#10;fun firebaseAuthWithGoogle(&#10;    idToken: String,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    val credential = GoogleAuthProvider.getCredential(idToken, null)&#10;    auth.signInWithCredential(credential)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) {&#10;                handleAuthSuccess(auth.currentUser, onResult)&#10;            } else {&#10;                onResult(false, task.exception?.message)&#10;            }&#10;        }&#10;}&#10;&#10;// --- FACEBOOK AUTH (MỚI) ---&#10;fun firebaseAuthWithFacebook(&#10;    token: AccessToken,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    val credential = FacebookAuthProvider.getCredential(token.token)&#10;    auth.signInWithCredential(credential)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) {&#10;                handleAuthSuccess(auth.currentUser, onResult)&#10;            } else {&#10;                onResult(false, task.exception?.message)&#10;            }&#10;        }&#10;}&#10;&#10;// --- GITHUB AUTH (MỚI) ---&#10;fun firebaseAuthWithGitHub(&#10;    activity: Activity,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    val provider = OAuthProvider.newBuilder(&quot;github.com&quot;)&#10;    // provider.addCustomParameter(&quot;login&quot;, &quot;your-email@example.com&quot;)&#10;&#10;    val pendingResultTask = auth.pendingAuthResult&#10;    if (pendingResultTask != null) {&#10;        pendingResultTask&#10;            .addOnSuccessListener { authResult -&gt;&#10;                handleAuthSuccess(authResult.user, onResult)&#10;            }&#10;            .addOnFailureListener { e -&gt;&#10;                onResult(false, e.message)&#10;            }&#10;    } else {&#10;        auth.startActivityForSignInWithProvider(activity, provider.build())&#10;            .addOnSuccessListener { authResult -&gt;&#10;                handleAuthSuccess(authResult.user, onResult)&#10;            }&#10;            .addOnFailureListener { e -&gt;&#10;                onResult(false, e.message)&#10;            }&#10;    }&#10;}&#10;&#10;// --- CÁC HÀM CŨ (EMAIL/PASSWORD) ---&#10;&#10;fun sendPasswordResetEmail(&#10;    email: String,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    auth.sendPasswordResetEmail(email)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) onResult(true, null)&#10;            else onResult(false, task.exception?.message)&#10;        }&#10;}&#10;&#10;fun createUserWithEmailAndPassword(&#10;    email: String,&#10;    password: String,&#10;    fullName: String,&#10;    username: String,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    auth.createUserWithEmailAndPassword(email, password)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) {&#10;                val user = auth.currentUser&#10;                if (user != null) {&#10;                    val defaultAvatar = &quot;https://firebasestorage.googleapis.com/v0/b/freshcookapp-b376c.firebasestorage.app/o/recipe_images%2Favatar_user.png?alt=media&amp;token=1db6c7a8-852f-4271-81df-3f076b38fea6&quot;&#10;                    val profileUpdates = UserProfileChangeRequest.Builder()&#10;                        .setDisplayName(fullName)&#10;                        .setPhotoUri(Uri.parse(defaultAvatar))&#10;                        .build()&#10;                    user.updateProfile(profileUpdates).addOnCompleteListener {&#10;                        saveUserToFirestore(user, fullName, username) { success -&gt;&#10;                            onResult(success, if (success) user.displayName else &quot;Failed to save user data.&quot;)&#10;                        }&#10;                    }&#10;                } else {&#10;                    onResult(false, &quot;User is null.&quot;)&#10;                }&#10;            } else {&#10;                onResult(false, task.exception?.message)&#10;            }&#10;        }&#10;}&#10;&#10;fun signInWithEmailAndPassword(&#10;    email: String,&#10;    password: String,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    auth.signInWithEmailAndPassword(email, password)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) onResult(true, auth.currentUser?.displayName)&#10;            else onResult(false, task.exception?.message)&#10;        }&#10;}&#10;&#10;// --- HELPER FUNCTIONS ---&#10;&#10;// Xử lý chung sau khi đăng nhập thành công (Google, GitHub, Phone, Facebook)&#10;fun handleAuthSuccess(user: FirebaseUser?, onResult: (Boolean, String?) -&gt; Unit) {&#10;    if (user != null) {&#10;        // Lấy tên hiển thị&#10;        val fullName = user.displayName ?: user.email?.substringBefore(&quot;@&quot;) ?: user.phoneNumber ?: &quot;User&quot;&#10;        val username = user.email?.split(&quot;@&quot;)?.firstOrNull() ?: user.uid&#10;&#10;        // ✅ QUAN TRỌNG: Trả về success NGAY LẬP TỨC (như Instagram, Facebook app)&#10;        // Vì Firebase Authentication đã thành công → User có thể dùng app&#10;        onResult(true, fullName)&#10;&#10;        // Lưu vào Firestore ở background (không ảnh hưởng đến login flow)&#10;        try {&#10;            saveUserToFirestore(user, fullName, username) { success -&gt;&#10;                if (!success) {&#10;                    android.util.Log.w(&quot;FirebaseAuth&quot;, &quot;⚠️ Firestore save failed, will retry later&quot;)&#10;                } else {&#10;                    android.util.Log.d(&quot;FirebaseAuth&quot;, &quot;✅ User saved to Firestore successfully&quot;)&#10;                }&#10;            }&#10;        } catch (e: Exception) {&#10;            android.util.Log.e(&quot;FirebaseAuth&quot;, &quot;❌ Error saving to Firestore: ${e.message}&quot;)&#10;        }&#10;    } else {&#10;        onResult(false, &quot;User is null.&quot;)&#10;    }&#10;}&#10;&#10;// Lưu hoặc Cập nhật user vào Firestore (Dùng SetOptions.merge để không mất dữ liệu cũ)&#10;fun saveUserToFirestore(&#10;    user: FirebaseUser,&#10;    fullName: String,&#10;    username: String,&#10;    onResult: (Boolean) -&gt; Unit&#10;) {&#10;    val db = FirebaseFirestore.getInstance()&#10;    val userRef = db.collection(&quot;users&quot;).document(user.uid)&#10;    val defaultAvatar = &quot;https://firebasestorage.googleapis.com/v0/b/freshcookapp-b376c.firebasestorage.app/o/recipe_images%2Favatar_user.png?alt=media&amp;token=1db6c7a8-852f-4271-81df-3f076b38fea6&quot;&#10;&#10;    val photoUrlToSave = user.photoUrl?.toString() ?: defaultAvatar&#10;&#10;    val userData = hashMapOf&lt;String, Any?&gt;(&#10;        &quot;uid&quot; to user.uid,&#10;        &quot;email&quot; to (user.email ?: &quot;&quot;),&#10;        &quot;phoneNumber&quot; to (user.phoneNumber ?: &quot;&quot;),&#10;        &quot;fullName&quot; to fullName,&#10;        &quot;name&quot; to fullName,&#10;        &quot;username&quot; to username,&#10;        &quot;photoUrl&quot; to photoUrlToSave&#10;    )&#10;&#10;    // Kiểm tra xem document đã tồn tại chưa&#10;    userRef.get()&#10;        .addOnSuccessListener { document -&gt;&#10;            if (!document.exists()) {&#10;                // Nếu là user mới -&gt; Thêm các trường khởi tạo&#10;                userData[&quot;gender&quot;] = &quot;Khác&quot;&#10;                userData[&quot;dateOfBirth&quot;] = null&#10;                userData[&quot;followerCount&quot;] = 0L&#10;                userData[&quot;followingCount&quot;] = 0L&#10;                userData[&quot;myDishesCount&quot;] = 0L&#10;            }&#10;&#10;            // Merge: Chỉ cập nhật các trường có trong userData, giữ nguyên các trường khác&#10;            userRef.set(userData, SetOptions.merge())&#10;                .addOnSuccessListener {&#10;                    android.util.Log.d(&quot;FirebaseAuth&quot;, &quot;✅ User saved to Firestore successfully&quot;)&#10;                    onResult(true)&#10;                }&#10;                .addOnFailureListener { e -&gt;&#10;                    android.util.Log.w(&quot;FirebaseAuth&quot;, &quot;⚠️ Firestore save failed: ${e.message}&quot;)&#10;                    onResult(false)&#10;                }&#10;        }&#10;        .addOnFailureListener { e -&gt;&#10;            // ⚠️ Nếu get() fail (do network issue), vẫn cố gắng save&#10;            android.util.Log.w(&quot;FirebaseAuth&quot;, &quot;⚠️ Firestore get failed, trying to save anyway: ${e.message}&quot;)&#10;&#10;            // Thêm các trường mặc định (giả sử là user mới)&#10;            userData[&quot;gender&quot;] = &quot;Khác&quot;&#10;            userData[&quot;dateOfBirth&quot;] = null&#10;            userData[&quot;followerCount&quot;] = 0L&#10;            userData[&quot;followingCount&quot;] = 0L&#10;            userData[&quot;myDishesCount&quot;] = 0L&#10;&#10;            userRef.set(userData, SetOptions.merge())&#10;                .addOnSuccessListener {&#10;                    android.util.Log.d(&quot;FirebaseAuth&quot;, &quot;✅ User saved to Firestore successfully (fallback)&quot;)&#10;                    onResult(true)&#10;                }&#10;                .addOnFailureListener { e2 -&gt;&#10;                    android.util.Log.e(&quot;FirebaseAuth&quot;, &quot;❌ Firestore save failed completely: ${e2.message}&quot;)&#10;                    onResult(false)&#10;                }&#10;        }&#10;}" />
              <option name="updatedContent" value="package com.example.freshcookapp.ui.screen.auth&#10;&#10;import android.app.Activity&#10;import android.net.Uri&#10;import com.facebook.AccessToken&#10;import com.google.firebase.auth.FacebookAuthProvider&#10;import com.google.firebase.auth.FirebaseAuth&#10;import com.google.firebase.auth.FirebaseUser&#10;import com.google.firebase.auth.GoogleAuthProvider&#10;import com.google.firebase.auth.OAuthProvider&#10;import com.google.firebase.auth.UserProfileChangeRequest&#10;import com.google.firebase.firestore.FirebaseFirestore&#10;import com.google.firebase.firestore.SetOptions&#10;&#10;// --- GOOGLE AUTH ---&#10;fun firebaseAuthWithGoogle(&#10;    idToken: String,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    val credential = GoogleAuthProvider.getCredential(idToken, null)&#10;    auth.signInWithCredential(credential)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) {&#10;                handleAuthSuccess(auth.currentUser, onResult)&#10;            } else {&#10;                onResult(false, task.exception?.message)&#10;            }&#10;        }&#10;}&#10;&#10;// --- FACEBOOK AUTH (MỚI) ---&#10;fun firebaseAuthWithFacebook(&#10;    token: AccessToken,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    val credential = FacebookAuthProvider.getCredential(token.token)&#10;    auth.signInWithCredential(credential)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) {&#10;                handleAuthSuccess(auth.currentUser, onResult)&#10;            } else {&#10;                onResult(false, task.exception?.message)&#10;            }&#10;        }&#10;}&#10;&#10;// --- GITHUB AUTH (MỚI) ---&#10;fun firebaseAuthWithGitHub(&#10;    activity: Activity,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    val provider = OAuthProvider.newBuilder(&quot;github.com&quot;)&#10;    // provider.addCustomParameter(&quot;login&quot;, &quot;your-email@example.com&quot;)&#10;&#10;    val pendingResultTask = auth.pendingAuthResult&#10;    if (pendingResultTask != null) {&#10;        pendingResultTask&#10;            .addOnSuccessListener { authResult -&gt;&#10;                handleAuthSuccess(authResult.user, onResult)&#10;            }&#10;            .addOnFailureListener { e -&gt;&#10;                onResult(false, e.message)&#10;            }&#10;    } else {&#10;        auth.startActivityForSignInWithProvider(activity, provider.build())&#10;            .addOnSuccessListener { authResult -&gt;&#10;                handleAuthSuccess(authResult.user, onResult)&#10;            }&#10;            .addOnFailureListener { e -&gt;&#10;                onResult(false, e.message)&#10;            }&#10;    }&#10;}&#10;&#10;// --- CÁC HÀM CŨ (EMAIL/PASSWORD) ---&#10;&#10;fun sendPasswordResetEmail(&#10;    email: String,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    auth.sendPasswordResetEmail(email)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) onResult(true, null)&#10;            else onResult(false, task.exception?.message)&#10;        }&#10;}&#10;&#10;fun createUserWithEmailAndPassword(&#10;    email: String,&#10;    password: String,&#10;    fullName: String,&#10;    username: String,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    auth.createUserWithEmailAndPassword(email, password)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) {&#10;                val user = auth.currentUser&#10;                if (user != null) {&#10;                    val defaultAvatar = &quot;https://firebasestorage.googleapis.com/v0/b/freshcookapp-b376c.firebasestorage.app/o/recipe_images%2Favatar_user.png?alt=media&amp;token=1db6c7a8-852f-4271-81df-3f076b38fea6&quot;&#10;                    val profileUpdates = UserProfileChangeRequest.Builder()&#10;                        .setDisplayName(fullName)&#10;                        .setPhotoUri(Uri.parse(defaultAvatar))&#10;                        .build()&#10;                    user.updateProfile(profileUpdates).addOnCompleteListener {&#10;                        saveUserToFirestore(user, fullName, username) { success -&gt;&#10;                            onResult(success, if (success) user.displayName else &quot;Failed to save user data.&quot;)&#10;                        }&#10;                    }&#10;                } else {&#10;                    onResult(false, &quot;User is null.&quot;)&#10;                }&#10;            } else {&#10;                onResult(false, task.exception?.message)&#10;            }&#10;        }&#10;}&#10;&#10;fun signInWithEmailAndPassword(&#10;    email: String,&#10;    password: String,&#10;    auth: FirebaseAuth,&#10;    onResult: (Boolean, String?) -&gt; Unit&#10;) {&#10;    auth.signInWithEmailAndPassword(email, password)&#10;        .addOnCompleteListener { task -&gt;&#10;            if (task.isSuccessful) onResult(true, auth.currentUser?.displayName)&#10;            else onResult(false, task.exception?.message)&#10;        }&#10;}&#10;&#10;// --- HELPER FUNCTIONS ---&#10;&#10;// Xử lý chung sau khi đăng nhập thành công (Google, GitHub, Phone, Facebook)&#10;fun handleAuthSuccess(user: FirebaseUser?, onResult: (Boolean, String?) -&gt; Unit) {&#10;    if (user != null) {&#10;        // Lấy tên hiển thị&#10;        val fullName = user.displayName ?: user.email?.substringBefore(&quot;@&quot;) ?: user.phoneNumber ?: &quot;User&quot;&#10;        &#10;        //  CẢI THIỆN: Tạo username đẹp hơn cho Facebook Login&#10;        val username = when {&#10;            // Nếu có email -&gt; dùng phần trước @&#10;            user.email != null -&gt; user.email!!.split(&quot;@&quot;).firstOrNull() ?: user.uid&#10;            // Nếu có displayName (Facebook, Google) -&gt; chuyển thành username&#10;            user.displayName != null -&gt; {&#10;                user.displayName!!&#10;                    .lowercase()&#10;                    .replace(&quot; &quot;, &quot;&quot;)&#10;                    .replace(Regex(&quot;[^a-z0-9]&quot;), &quot;&quot;) // Chỉ giữ chữ và số&#10;                    .take(20) // Giới hạn 20 ký tự&#10;                    .ifEmpty { user.uid.take(8) } // Nếu rỗng thì dùng 8 ký tự đầu của UID&#10;            }&#10;            // Nếu có phone number&#10;            user.phoneNumber != null -&gt; user.phoneNumber!!.replace(&quot;+&quot;, &quot;&quot;).take(10)&#10;            // Fallback: dùng 8 ký tự đầu của UID&#10;            else -&gt; user.uid.take(8)&#10;        }&#10;&#10;        // ✅ QUAN TRỌNG: Trả về success NGAY LẬP TỨC (như Instagram, Facebook app)&#10;        // Vì Firebase Authentication đã thành công → User có thể dùng app&#10;        onResult(true, fullName)&#10;&#10;        // Lưu vào Firestore ở background (không ảnh hưởng đến login flow)&#10;        try {&#10;            saveUserToFirestore(user, fullName, username) { success -&gt;&#10;                if (!success) {&#10;                    android.util.Log.w(&quot;FirebaseAuth&quot;, &quot;⚠️ Firestore save failed, will retry later&quot;)&#10;                } else {&#10;                    android.util.Log.d(&quot;FirebaseAuth&quot;, &quot;✅ User saved to Firestore successfully&quot;)&#10;                }&#10;            }&#10;        } catch (e: Exception) {&#10;            android.util.Log.e(&quot;FirebaseAuth&quot;, &quot;❌ Error saving to Firestore: ${e.message}&quot;)&#10;        }&#10;    } else {&#10;        onResult(false, &quot;User is null.&quot;)&#10;    }&#10;}&#10;&#10;// Lưu hoặc Cập nhật user vào Firestore (Dùng SetOptions.merge để không mất dữ liệu cũ)&#10;fun saveUserToFirestore(&#10;    user: FirebaseUser,&#10;    fullName: String,&#10;    username: String,&#10;    onResult: (Boolean) -&gt; Unit&#10;) {&#10;    val db = FirebaseFirestore.getInstance()&#10;    val userRef = db.collection(&quot;users&quot;).document(user.uid)&#10;    val defaultAvatar = &quot;https://firebasestorage.googleapis.com/v0/b/freshcookapp-b376c.firebasestorage.app/o/recipe_images%2Favatar_user.png?alt=media&amp;token=1db6c7a8-852f-4271-81df-3f076b38fea6&quot;&#10;&#10;    val photoUrlToSave = user.photoUrl?.toString() ?: defaultAvatar&#10;&#10;    val userData = hashMapOf&lt;String, Any?&gt;(&#10;        &quot;uid&quot; to user.uid,&#10;        &quot;email&quot; to (user.email ?: &quot;&quot;),&#10;        &quot;phoneNumber&quot; to (user.phoneNumber ?: &quot;&quot;),&#10;        &quot;fullName&quot; to fullName,&#10;        &quot;name&quot; to fullName,&#10;        &quot;username&quot; to username,&#10;        &quot;photoUrl&quot; to photoUrlToSave&#10;    )&#10;&#10;    // Kiểm tra xem document đã tồn tại chưa&#10;    userRef.get()&#10;        .addOnSuccessListener { document -&gt;&#10;            if (!document.exists()) {&#10;                // Nếu là user mới -&gt; Thêm các trường khởi tạo&#10;                userData[&quot;gender&quot;] = &quot;Khác&quot;&#10;                userData[&quot;dateOfBirth&quot;] = null&#10;                userData[&quot;followerCount&quot;] = 0L&#10;                userData[&quot;followingCount&quot;] = 0L&#10;                userData[&quot;myDishesCount&quot;] = 0L&#10;            }&#10;&#10;            // Merge: Chỉ cập nhật các trường có trong userData, giữ nguyên các trường khác&#10;            userRef.set(userData, SetOptions.merge())&#10;                .addOnSuccessListener {&#10;                    android.util.Log.d(&quot;FirebaseAuth&quot;, &quot;✅ User saved to Firestore successfully&quot;)&#10;                    onResult(true)&#10;                }&#10;                .addOnFailureListener { e -&gt;&#10;                    android.util.Log.w(&quot;FirebaseAuth&quot;, &quot;⚠️ Firestore save failed: ${e.message}&quot;)&#10;                    onResult(false)&#10;                }&#10;        }&#10;        .addOnFailureListener { e -&gt;&#10;            // ⚠️ Nếu get() fail (do network issue), vẫn cố gắng save&#10;            android.util.Log.w(&quot;FirebaseAuth&quot;, &quot;⚠️ Firestore get failed, trying to save anyway: ${e.message}&quot;)&#10;&#10;            // Thêm các trường mặc định (giả sử là user mới)&#10;            userData[&quot;gender&quot;] = &quot;Khác&quot;&#10;            userData[&quot;dateOfBirth&quot;] = null&#10;            userData[&quot;followerCount&quot;] = 0L&#10;            userData[&quot;followingCount&quot;] = 0L&#10;            userData[&quot;myDishesCount&quot;] = 0L&#10;&#10;            userRef.set(userData, SetOptions.merge())&#10;                .addOnSuccessListener {&#10;                    android.util.Log.d(&quot;FirebaseAuth&quot;, &quot;✅ User saved to Firestore successfully (fallback)&quot;)&#10;                    onResult(true)&#10;                }&#10;                .addOnFailureListener { e2 -&gt;&#10;                    android.util.Log.e(&quot;FirebaseAuth&quot;, &quot;❌ Firestore save failed completely: ${e2.message}&quot;)&#10;                    onResult(false)&#10;                }&#10;        }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>